## Compose version key is obsolete; omitted intentionally.

x-health: &health
  interval: 10s
  timeout: 5s
  retries: 12
  start_period: 20s

x-health-dev: &health-dev
  interval: 15s
  timeout: 10s
  retries: 3
  start_period: 30s

networks:
  edge:
    name: xarvis_edge
  backend:
    name: xarvis_backend

volumes:
  mosquitto_data:
  mosquitto_log:
  qdrant_data:
  ollama_data:
  tei_data:
  redis_data:


services:
  # ───────────────────────── Reverse Proxy (routes /v1/*) ─────────────────────────
  traefik:
    profiles: [ "proxy" ]
    image: traefik:v3.1
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.network=xarvis_backend"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8081:8080" # dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks: [ edge, backend ]
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8080/api/rawdata" ]
      <<: *health
    labels:
      - "traefik.enable=true"

  # ───────────────────────── Xarvis Core (Go) ─────────────────────────
  xarvis-core:
    build:
      context: ./
      dockerfile: Dockerfile
      target: dev
    restart: unless-stopped
    environment:
      # In dev, read config from the repo root
      XARVIS_CONFIG: /app/config_dev.yaml
      PORT: "8088"
    volumes:
      # Live-reload: bind mount source into /app for Air
      - ./:/app
    # Ensure we run Air in dev, even if a cached image has an ENTRYPOINT
    entrypoint: ""
    command: [ "air", "-c", ".air.toml" ]
    depends_on:
      - mosquitto
      - redis
    networks: [ backend ]
    ports: [ "8088:8088" ]
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8088/health" ]
      <<: *health
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.xarvis.rule=PathPrefix(`/v1/app`)"
      - "traefik.http.routers.xarvis.entrypoints=web"
      - "traefik.http.routers.xarvis.priority=100"
      - "traefik.http.services.xarvis.loadbalancer.server.port=8088"
      - "traefik.http.middlewares.xarvis-strip.stripprefix.prefixes=/v1/app"
      - "traefik.http.routers.xarvis.middlewares=xarvis-strip@docker"

  # ───────────────────────── Messaging (ESP audio/control) ─────────────────────────
  mosquitto:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    networks: [ backend, edge ]
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
      - ./infra/mosquitto:/mosquitto/config
    healthcheck:
      test: [ "CMD-SHELL", "mosquitto -c /mosquitto/config/mosquitto.conf -p 0 -v >/dev/null 2>&1 || exit 0" ]
      <<: *health
    labels:
      - "traefik.enable=false"

  # ───────────────────────── Caching and Session Storage ─────────────────────────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    networks: [ backend ]
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --requirepass ""
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      <<: *health
    labels:
      - "traefik.enable=false"

  # ───────────────────────── Voice (opt-in with --profile voice) ─────────────────────────
  stt-whisper:
    profiles: [ "voice" ]
    image: onerahmet/openai-whisper-asr-webservice:latest
    # If running on Apple Silicon and the image lacks arm64,
    # uncomment the next line to use x86 emulation.
    platform: linux/amd64
    environment:
      ASR_MODEL: base.en
      ASR_ENGINE: openai_whisper
    networks: [ backend ]
    ports: [ "8080:9000" ]
    healthcheck:
      # Check if the whisper service is responding
      test: [ "CMD-SHELL", "wget -qO- http://localhost:9000/health || curl -fsS http://localhost:9000/health || exit 1" ]
      <<: *health
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.stt.rule=PathPrefix(`/v1/stt`)"
      - "traefik.http.routers.stt.entrypoints=web"
      - "traefik.http.services.stt.loadbalancer.server.port=9000"
      - "traefik.http.middlewares.stt-strip.stripprefix.prefixes=/v1/stt"
      - "traefik.http.routers.stt.middlewares=stt-strip@docker"

  tts-piper:
    profiles: [ "voice" ]
    image: rhasspy/wyoming-piper:latest
    # platform: linux/amd64  # uncomment on Apple Silicon if needed
    command:
      - --voice
      - en_US-libritts-high
    environment:
      PUID: 1000
      PGID: 1000
      TZ: ${TZ:-Etc/UTC}
      PIPER_VOICE: en_US-libritts-high
    networks: [ backend ]
    # LinuxServer Piper exposes 10200 in-container; map to 5002 externally
    ports: [ "5002:10200", "5003:5000" ]
    volumes:
      - ./infra/piper:/config
      - ./infra/piper/models:/models
    healthcheck:
      # Use short timeouts and fallback endpoints to avoid hangs
      test: [ "CMD-SHELL", "bash -c 'exec 3<>/dev/tcp/127.0.0.1/10200'" ]
      <<: *health
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tts.rule=PathPrefix(`/v1/tts`)"
      - "traefik.http.routers.tts.entrypoints=web"
      - "traefik.http.services.tts.loadbalancer.server.port=10200"
      - "traefik.http.middlewares.tts-strip.stripprefix.prefixes=/v1/tts"
      - "traefik.http.routers.tts.middlewares=tts-strip@docker"

  # ───────────────────────── Local LLMs & Embeddings (opt-in with --profile ai-local) ─────────────────────────
  ollama:
    profiles: [ "ai-local" ]
    image: ollama/ollama:latest
    restart: unless-stopped
    networks: [ backend ]
    ports: [ "11434:11434" ]
    volumes:
      - ./infra/models/ollama:/root/.ollama
    healthcheck:
      # Use the built-in CLI to verify the API is responsive.
      # Many minimal images lack wget/curl, causing false unhealthy states.
      test: [ "CMD", "ollama", "list" ]
      # Reuse common timings, but give the server extra warmup time.
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ollama.rule=PathPrefix(`/v1/llm/ollama`)"
      - "traefik.http.routers.ollama.entrypoints=web"
      - "traefik.http.services.ollama.loadbalancer.server.port=11434"
      - "traefik.http.middlewares.ollama-strip.stripprefix.prefixes=/v1/llm/ollama"
      - "traefik.http.routers.ollama.middlewares=ollama-strip@docker"

  embeddings-tei:
    profiles: [ "ai-local" ]
    platform: linux/amd64 # uncomment on Apple Silicon if needed
    image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.5
    environment:
      MODEL_ID: mixedbread-ai/mxbai-embed-large-v1
      NUM_SHARD: "1"
    networks: [ backend ]
    ports: [ "8082:80" ]
    volumes:
      - tei_data:/data
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:80/health" ]
      <<: *health
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.embed.rule=PathPrefix(`/v1/embed`)"
      - "traefik.http.routers.embed.entrypoints=web"
      - "traefik.http.services.embed.loadbalancer.server.port=80"
      - "traefik.http.middlewares.embed-strip.stripprefix.prefixes=/v1/embed"
      - "traefik.http.routers.embed.middlewares=embed-strip@docker"

  # ───────────────────────── Optional Vector Backend: Qdrant ─────────────────────────
  qdrant:
    profiles: [ "vector-qdrant" ]
    image: qdrant/qdrant:latest
    restart: unless-stopped
    networks: [ backend ]
    ports: [ "6333:6333" ]
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:6333/readyz" ]
      <<: *health
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qdrant.rule=PathPrefix(`/v1/vector`)"
      - "traefik.http.routers.qdrant.entrypoints=web"
      - "traefik.http.services.qdrant.loadbalancer.server.port=6333"
      - "traefik.http.middlewares.qdrant-strip.stripprefix.prefixes=/v1/vector"
      - "traefik.http.routers.qdrant.middlewares=qdrant-strip@docker"

  # ───────────────────────── Web Client (opt-in with --profile client) ─────────────────────────
  xarvis-client:
    profiles: [ "client" ]
    build:
      context: ./services/client
      dockerfile: Dockerfile
      target: development
    restart: unless-stopped
    environment:
      NODE_ENV: development
    volumes:
      # Live-reload: bind mount source for development
      - ./services/client:/app
      - /app/node_modules
    networks: [ backend ]
    ports: [ "5173:5173" ]
    depends_on:
      - xarvis-core
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:5173" ]
      <<: *health-dev
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.client.rule=PathPrefix(`/`)"
      - "traefik.http.routers.client.entrypoints=web"
      - "traefik.http.routers.client.priority=1"
      - "traefik.http.services.client.loadbalancer.server.port=5173"

  # Production client (opt-in with --profile client-prod)
  xarvis-client-prod:
    profiles: [ "client-prod" ]
    build:
      context: ./services/client
      dockerfile: Dockerfile
      target: production
    restart: unless-stopped
    networks: [ backend ]
    ports: [ "3000:80" ]
    depends_on:
      - xarvis-core
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:80" ]
      <<: *health
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.client-prod.rule=PathPrefix(`/`)"
      - "traefik.http.routers.client-prod.entrypoints=web"
      - "traefik.http.routers.client-prod.priority=1"
      - "traefik.http.services.client-prod.loadbalancer.server.port=80"

  # ───────────────────────── Local TiDB for dev (Serverless uses DSN; no container) ─────────────────────────
  tidb-local:
    profiles: [ "tidb-local" ]
    image: pingcap/tidb:latest
    command: [ "--store=unistore", "--path=127.0.0.1:0" ]
    networks: [ backend ]
    ports:
      - "4000:4000" # MySQL protocol
      - "10080:10080" # status
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:10080/status" ]
      <<: *health
